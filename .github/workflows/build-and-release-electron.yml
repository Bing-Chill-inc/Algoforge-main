name: Build and Release Electron App

on:
    push:
        tags:
            - "v*.*.*" # This will trigger on pushes to tags starting with 'v' followed by numbers and dots (e.g., v1.0.0, v1.2.3)

permissions:
    contents: write

jobs:
    create-release:
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
        steps:
            - name: Create GitHub Release
              id: create_release
              uses: actions/create-release@v1
              with:
                  # Use the tag name from the push event
                  tag_name: ${{ github.ref }}
                  # Set the release name based on the tag
                  release_name: "Algoforge Release ${{ github.ref }}"
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-and-release-win-lnx:
        runs-on: ubuntu-latest
        needs: create-release

        strategy:
            matrix:
                build:
                    - command: "package:win:x64"
                      tag: "windows-x64"
                      zipFileName: "Algoforge-Windows-x64.zip"
                      name: "Windows x64"
                    - command: "package:win:arm64"
                      tag: "windows-arm64"
                      zipFileName: "Algoforge-Windows-ARM64.zip"
                      name: "Windows x64"
                    - command: "package:lnx:x64"
                      tag: "linux-x64"
                      zipFileName: "Algoforge-Linux-x64.zip"
                      name: "Linux x64"
                    - command: "package:lnx:arm64"
                      tag: "linux-arm64"
                      zipFileName: "Algoforge-Linux-ARM64.zip"
                      name: "Linux x64"
                    - command: "package:exam:win:x64"
                      tag: "windows-exam-x64"
                      zipFileName: "Algoforge-ExamEdition-Windows-x64.zip"
                      name: "Exam Edition Windows x64"
                    - command: "package:exam:lnx:x64"
                      tag: "linux-exam-x64"
                      zipFileName: "Algoforge-ExamEdition-Linux-x64.zip"
                      name: "Exam Edition Linux x64"

        steps:
            - name: Checkout code (with submodules)
              uses: actions/checkout@v3
              with:
                  submodules: true # Initialize and update submodules

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20 # Use a compatible Node.js version

            - name: Install dependencies
              working-directory: src/electron
              run: npm install

            - name: Run build script
              working-directory: src/electron
              run: npm run ${{ matrix.build.command }}

            - name: Package build artifact
              working-directory: src/electron/out
              run: zip -r ${{ matrix.build.zipFileName }} ./*

            - name: Upload build artifact to release
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./src/electron/out/${{ matrix.build.zipFileName }}
                  asset_name: ${{ matrix.build.zipFileName }}
                  asset_content_type: application/zip

    build-and-release-darwin:
        runs-on: macos-latest
        needs: create-release

        strategy:
            matrix:
                build:
                    - command: "package:mac:x64"
                      tag: "mac-x64"
                      dmgFileName: "Algoforge-Mac-x64.dmg"
                      name: "MacOS x64"
                    - command: "package:mac:arm64"
                      tag: "mac-arm64"
                      dmgFileName: "Algoforge-Mac-ARM64.dmg"
                      name: "MacOS Apple Silicon (ARM64)"
                    - command: "package:exam:mac:x64"
                      tag: "mac-exam-x64"
                      dmgFileName: "Algoforge-ExamEdition-Mac-x64.dmg"
                      name: "Exam Edition MacOS x64"
                    - command: "package:exam:mac:arm64"
                      tag: "mac-exam-arm64"
                      dmgFileName: "Algoforge-ExamEdition-Mac-ARM64.dmg"
                      name: "Exam Edition MacOS Apple Silicon (ARM64)"

        steps:
            - name: Checkout code (with submodules)
              uses: actions/checkout@v3
              with:
                  submodules: true # Initialize and update submodules

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20 # Use a compatible Node.js version

            - name: Install dependencies
              working-directory: src/electron
              run: npm install

            - name: Run build script
              working-directory: src/electron
              run: npm run ${{ matrix.build.command }}

            - name: Import Apple signing certificate
              env:
                  MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
                  MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
              run: |
                  set -euo pipefail
                  if [[ -z "${MACOS_CERTIFICATE_P12_BASE64:-}" ]]; then
                      echo "::error::Missing secret MACOS_CERTIFICATE_P12_BASE64"
                      exit 1
                  fi
                  if [[ -z "${MACOS_CERTIFICATE_PASSWORD:-}" ]]; then
                      echo "::error::Missing secret MACOS_CERTIFICATE_PASSWORD"
                      exit 1
                  fi

                  CERTIFICATE_PATH="$RUNNER_TEMP/macos-signing-cert.p12"
                  KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
                  KEYCHAIN_PASSWORD="$(uuidgen)"

                  if ! echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > "$CERTIFICATE_PATH" 2>/dev/null; then
                      echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 -D > "$CERTIFICATE_PATH"
                  fi

                  security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
                  security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
                  security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
                  security import "$CERTIFICATE_PATH" -P "$MACOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
                  EXISTING_KEYCHAINS="$(security list-keychains -d user | tr -d '\"' | xargs)"
                  security list-keychains -d user -s "$KEYCHAIN_PATH" $EXISTING_KEYCHAINS
                  security default-keychain -d user -s "$KEYCHAIN_PATH"
                  security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
                  security find-identity -v -p codesigning "$KEYCHAIN_PATH"

            - name: Build signed and notarized DMG
              working-directory: src/electron
              env:
                  MACOS_SIGN_IDENTITY: ${{ secrets.MACOS_SIGN_IDENTITY }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
                  APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
              run: |
                  set -euo pipefail
                  APP_PATH="$(find out -type d -name '*.app' -print -quit)"
                  if [[ -z "${APP_PATH:-}" ]]; then
                      echo "::error::No .app bundle found in src/electron/out"
                      exit 1
                  fi
                  ./scripts/make_dmg_ci.sh "$APP_PATH" "out/${{ matrix.build.dmgFileName }}"

            - name: Upload build artifact to release
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./src/electron/out/${{ matrix.build.dmgFileName }}
                  asset_name: ${{ matrix.build.dmgFileName }}
                  asset_content_type: application/x-apple-diskimage
